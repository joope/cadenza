<!doctype html>
<html lang="en">
  <head>
    <title>kivachätti</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="/tyyli.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  </head>
  <body>
  <div id="top"></div>
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
  	<div class="navbar-header pull-left">
      <a id="room" class="navbar-brand truncate" href="#">Title Here</a>
    </div>
    <div class="nav pull-right">
        <button class="btn btn-default asetukset dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
          Asetukset
        <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
          <li id="rightButton"><button id="ylaButton" class="btn btn-default" onclick="buttonToForm();">Vaihda tunnus</button></li>
          <li role="separator" class="divider"></li>
          <li><div class="checkbox">
                <label><input id="autoscroll" type="checkbox" checked> Autoscroll</label></div>
          </li>
          <li><div class="checkbox">
                <label><input id="yonakyma" type="checkbox" disabled> Yönäkymä</label></div>
          </li>
          <li role="separator" class="divider"></li>
          <li id="roompassword"><button id="ylaButton" class="btn btn-default" onclick="buttonToForm();">Huoneen salasana</button></li>
          <li><div class="checkbox">
                <label><input id="yksityinen" type="checkbox"> Yksityinen huone</label></div>
          </li>
          <li><a href="#">Kick/Ban</a></li>
          <li><a href="#">Tervehdysviesti</a></li>
          <li><a href="#">Viestihistorian pituus</a></li>
        </ul>
    </div>
    </div>
  </nav>
    <div class="container.fluid">
      <div id="messageContainer">
        <table id="messageBox" class="table table-hover table-condensed striped">
            <tbody>
            </tbody>
        </table>
      </div>
      <div id="footer">
        <div class="container.fluid">
          <div id="infoContainer">
            <p id ="infoMessage">no connection to server.</p>
          </div>
          <div id="messageFieldContainer" class="input-group">
            <form id="teksti" action="">
              <input type="text" id="messageField" class="form-control" placeholder="kirjoita jotain" autocomplete="off">
              <button id="sendButton" class="btn btn-primary" type="submit">Lähetä</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="/bootstrap.min.js"></script>
    <script>
    var id = localStorage.getItem('userid');
    var socket = io('http://192.168.0.125', {query: "id=" + id});
    var rowid = 0;
    var oldNick = "anon";
    var roomname = "";
    var btn;

    socket.on('newUser', function(data){
      localStorage.setItem('userid', data);
    });

    socket.on('userStatus', function(userdata){
      oldNick = userdata;
      $("#ylaButton").text(userdata);
    });

    socket.on('roomStatus', function(room){
      roomname = room.name;
      $("#room").text("#"+ room.name + "(" + room.users + ")");
      $("title").text(oldNick + "@"+ room.name);
    });

    socket.on('infoMessage', function(message){
      $('#infoMessage').text(message.message);
      $('#infoMessage').removeClass().addClass(message.type);
      //$('#infoTime').text(message.timestamp);
    });

    socket.on('noRights', function(huone){
      window.alert('Ei oikeuksia: ' + huone);
    });

    socket.on('messageHistory', function(msg_hist){
      $('#messageBox tbody').remove();
      msg_hist.forEach(function(message){
        appendMessage(message, true);
      });
      scrollToBottom();
    });

    socket.on('newMessage', function(message){
      appendMessage(message);
      $('#infoMessage').text("last message: " + message.timestamp);
      $('#infoMessage').removeClass().addClass("normal");
      scrollToBottom();
    });

    $('#teksti').submit(function(){
      if(validInput($('#messageField').val(), 1000)){
		var content = $('#messageField').val(); //get content from field
		//append message locally
		appendMessage({'content': content, 'sender': oldnick, 'timestamp': new Date().toLocaleTimeString()});
		socket.emit('sendMessage', content);  //emit message to others
      $('#messageField').val('');          // empty message field
    } else{
      //some warning?
    }
      return false; // don't follow the link
    });

    $('#yksityinen').change(function(){
      if($(this).is(":checked")) {
          //var val = confirm('Asetetaanko huone yksityiseksi? Tätä toimintoa ei voi peruuttaa');
          socket.emit('roomToPrivate', roomname, id);
        }
    });

    //prevent dropdown from closing on click event
    $('.dropdown-menu').click(function(e) {
              e.stopPropagation();
    });

    function changeNick(){
      var newNick = $('#rightForm').val();
      $('#nick').replaceWith('<li id="rightButton"><button id="ylaButton" class="btn btn-default" onclick="buttonToForm();"></button></li>');
      if(validInput(newNick, 32)){
        $('#ylaButton').text(newNick);
        //$('#rightButton a').text(newNick);
        socket.emit('changeNick', newNick);
        oldNick = newNick;
      } else{
        $('#ylaButton').text(oldNick);
      }
      return false;
    }

    function buttonToForm(){
        btn = $('#rightButton');
        var form = $('<form>', {
          'id': 'nick',
          'action': "javascript:void(0);",
          'onsubmit': 'changeNick()'
        });
        var input = $('<input />', {
          'type': 'text',
          'id': 'rightForm',
          'style': 'margin-left: 10px; padding-right: 10px; margin-top: 6px; width: 200px; ',
          'class': 'form-control',
          'placeholder': 'kirjoita uusi tunnus',
          'onblur': 'changeNick()'
        });
        form.append(input);
        $('#rightButton').replaceWith(form);
        $('#rightForm').focus();
    }

    function validInput(string, len){
      if($.trim(string) != '' && string.length < len){      //if nonempty
        return true;
      }
      return false;                                        // empty message field
    }

    function appendMessage(message, json){
      //laatu: kello kaksi aamuyöllä
      if(json){
        message = JSON.parse(message);
      }
      var hm = message.timestamp.split(':');
      hm = hm[0] + ":" + hm[1] + " ";
      var row = $("<tr>");
      var cell = $("<td>");
      var text = $("<span>");
      var time = $("<span>", {
        'id': 'timestamp'
      });
      var bold = $("<strong>");
      $(bold).text("<" + message.sender + "> ");
      $(text).text(message.contents);
      $(time).text(hm);
      row.append(cell.append(time).append(bold).append(text));

      $("#messageBox").append(row);
    }

    function scrollToBottom(){
      if($('#autoscroll').is(":checked")){
        var table = $("#messageContainer");
        table.animate({ scrollTop: table.prop("scrollHeight") - table.height()},  200);
      }
    }


    </script>
  </body>
</html>
