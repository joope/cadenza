<!doctype html>
<html lang="en">
  <head>
    <title>kakofonia</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="/tyyli.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  </head>
  <body>
  <div id="top"></div>
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
  	<div class="navbar-header pull-left">
      <a id="room" class="navbar-brand truncate" href="#">Title Here</a>
    </div>
    <div class="nav navbar-header pull-right">
      <li id="rightButton"><button id="ylaButton" class="btn btn-primary navbar-btn" onclick="buttonToForm();">Vaihda tunnus</button></li>
    </div>
    </div>
  </nav>
    <div class="container.fluid">
      <div id="messageContainer">
        <table id="messageBox" class="table table-hover table-condensed striped">
            <tbody>
            </tbody>
        </table>
      </div>
      <div id="footer">
        <div class="container.fluid">
          <div id="infoContainer">
            <p id ="infoMessage">no connection to server.</p>
          </div>
          <div id="messageFieldContainer" class="input-group">
            <form id="teksti" action="">
              <input type="text" id="messageField" class="form-control" placeholder="kirjoita jotain" autocomplete="off">
              <button id="sendButton" class="btn btn-primary" type="submit">Lähetä</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="/bootstrap.min.js"></script>
    <script>
    var id = localStorage.getItem('userid');
    var socket = io('http://192.168.0.125', {query: "id=" + id});
    var rowid = 0;
    var oldNick = "anon";
    var btn;

    socket.on('newUser', function(data){
      localStorage.setItem('userid', data);
    });

    socket.on('userStatus', function(userdata){
      $("#ylaButton").text(userdata);
    });

    socket.on('roomStatus', function(room){
      $("#room").text("#"+ room.name + "(" + room.users + ")");
      $("title").text("#"+ room.name);
    });

    socket.on('infoMessage', function(message){
      $('#infoMessage').text(message.message);
      //$('#infoTime').text(message.timestamp);
    });

    socket.on('messageHistory', function(history){
      $('#messageBox tbody').remove();       // stupid hack
      for (var i = 0; i < history.length; i++) {
        appendMessage(history[i]);
      }
      scrollToBottom();
    });

    socket.on('newMessage', function(message){
      appendMessage(message);
      $('#infoMessage').text("last message: " + message.timestamp);
      scrollToBottom();
    });

    $('#teksti').submit(function(){
      if(validInput($('#messageField').val())){
      socket.emit('sendMessage', $('#messageField').val()); //get message from field
      $('#messageField').val('');          // empty message field
    } else{
      //some warning?
    }
      return false; // don't follow the link
    });

    function changeNick(){
      var newNick = $('#rightForm').val();
      $('#nick').replaceWith('<li id="rightButton"><button id="ylaButton" class="btn btn-primary navbar-btn" onclick="buttonToForm();"></button></li>');
      if(validInput(newNick)){
        $('#ylaButton').text(newNick);
        //$('#rightButton a').text(newNick);
        socket.emit('changeNick', newNick);
        oldNick = newNick;
      } else{
        $('#ylaButton').text(oldNick);
      }
      return false;
    }

    function buttonToForm(){
        btn = $('#rightButton');
        var form = $('<form>', {
          'id': 'nick',
          'action': "javascript:void(0);",
          'onsubmit': 'changeNick()'
        });
        var input = $('<input />', {
          'type': 'text',
          'id': 'rightForm',
          'style': 'margin-right: 10px; margin-top: 9px; width: 250px; ',
          'class': 'form-control',
          'placeholder': 'kirjoita uusi tunnus',
          'onblur': 'changeNick()'
        });
        form.append(input);
        $('#rightButton').replaceWith(form);
        $('#rightForm').focus();
    }

    function validInput(string){
      if($.trim(string) != ''){                             //if nonempty
        return true;
      }
      return false;                                        // empty message field
    }

    function appendMessage(message){
      //laatu: kello kaksi aamuyöllä
      var hm = message.timestamp.split(':');
      hm = hm[0] + ":" + hm[1] + " ";
      var row = $("<tr>");
      var cell = $("<td>");
      var text = $("<span>");
      var time = $("<span>", {
        'id': 'timestamp'
      });
      var bold = $("<strong>");
      $(bold).text("<" + message.sender + "> ");
      $(text).text(message.contents);
      //$(time).text(hm);
      row.append(cell.append(time).append(bold).append(text));

      $("#messageBox").append(row);
    }

    function scrollToBottom(){
      //toggle off if user is scrolling?
      var table = $("#messageContainer");
      table.animate({ scrollTop: table.prop("scrollHeight") - table.height()},  200);
    }


    </script>
  </body>
</html>
